//"use strict";

class WebObject {
    constructor() {
        this.responseCallbacks = {};
    }

    pushCallBack(funtionName, args, callback) {
		var callbackId = "";
		if (callback) {
			callbackId = funtionName + "_" + this.generateUniqueId();
			this.responseCallbacks[callbackId] = callback;
		}
    }
	
	popCallBack(args, callbackId) {
		if (callbackId == "") {
			console.error("have no callback!!!");
			return;
		}
		
		this.responseCallbacks[callbackId](args);
        delete this.responseCallbacks[callbackId];
	}
	
	onMessage(args) {
		console.log("onMessage", args);
	}
	
	generateUniqueId() {
			var uid = this.randomString(10) + "_" + (new Date()).getTime();
			 console.log(uid);
			 return uid;
		}
		
	randomString(len) {
		len = len || 32;
		var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
		var maxPos = $chars.length;
		var pwd = '';
		for (var i = 0; i < len; i++) {
			pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
		}
		return pwd;
	}
}

class Test extends WebObject {
	constructor(webBridge, id) {
        super();
		this.WebBridge = webBridge;
		this.id = id;
    }
	
	testAPI(callback) {
	  this.WebBridge.exec(this.id, "testAPI", {}, callback);
	}
}

class WebBridge extends WebObject {
	constructor() {
	    super();
		this.nativeBridge = null;
		this.objects = {};
		this.inited = false;
	}
	
	init(callback) {
	    var pThis = this;
		new QWebChannel(qt.webChannelTransport, function(channel) {
			    pThis.inited = true;
				console.log("init finished");
				pThis.nativeBridge = channel.objects.nativeBridge;
				var callBackObject = pThis;
				if (!pThis.nativeBridge) {
					console.error("WebBridge init failed !!!!");
					callBackObject = null;
				}
				
				pThis.nativeBridge.onCreateObject.connect(function (objectId, callbackId, args) {
				console.log("onCreateObject", objectId, callbackId, args);
					var obj = pThis.objects[objectId];
					if (!obj) {
						console.error("WebBridge onCreateObject " + objectId + "," + callbackId + "failed");
						return;
					}
					if (args.length<=0) {
						console.error("onCreateObject error args:", args);
						return;
					}
					var arg = args[0] == 0?null:obj;
					obj.popCallBack(callbackId, arg);
				});
				
				pThis.nativeBridge.onExec.connect(function (objectId, callbackId, args) {
					var obj = pThis.objects[objectId];
					if (!obj) {
						console.error("WebBridge onmessage " + objectId + "," + callbackId + "failed");
						return;
					}
					obj.popCallBack(callbackId, args);
				});
				
				pThis.nativeBridge.onMessage.connect(function (objectId, callbackId, args) {
					var obj = pThis.objects[objectId];
					if (!obj) {
						console.error("WebBridge onmessage " + objectId + "," + callbackId + "failed");
						return;
					}
					obj.onMessage(callbackId, args);
				});
	
				if (callback) {
					callback(callBackObject);
				}
		});
	}
	
	createObject(className, callback) {
	   	if (!this.nativeBridge) {
			console.error("WebBridge not inited, please init first!!!!");
			return -1;
		}
		
		try {
		console.log("createObject ", "new " + className + "();");
			var obj = null;
			var objectId = className + this.generateUniqueId();
			if (className == "Test") {
				obj = new Test(this, objectId);
			} else {
				console.log("createObject " + className + " failed");
				return -1;
			}
			
			
            this.objects[objectId] = obj;
            var functionName = "createObject";
			this.pushCallBack(functionName, {}, callback);
            this.nativeBridge.createObject(objectId, className, callback);
			
            return 0;			
		} catch(e) {
			console.error("create object '" + className + "' failed", e); 
		}  
		return -1;
	}
	
	exec(objectId, functionName, args, callback) {
		var obj = this.objects[objectId];
		if (!obj) {
			console.error("WebBridge exec "+"functionName " + "," + objectId + "failed");
			return -1;
		}
		
		obj.pushCallBack(functionName, args, callback);
	    this.nativeBridge.exec(objectId, funtionName, args, callback);
	}
}

function bridge(callback) {
    console.log("bridge construct");
	var responseCallbacks = {};
	var o_ = {};
	
    new QWebChannel(qt.webChannelTransport, function(channel) {
        //console.log("init finished");
        init(channel.objects.nativeBridge, o_);
        if (callback) {
            callback(o_);
        }
    });
	
    function init(nativeBridge, callback) {
		console.log(nativeBridge);

        o_.normal = function(callback) {
            console.log("nomal");
			request("normal", {}, callback);
        }
		
		o_.minimize = function(callback) {
			console.log("minimize");
			request("minimize", {}, callback);
		}
		
		o_.maximize = function(callback) {
            console.log("maximize");
			request("maximize", {}, callback);
        }
		
		function request(cmd, args, callback) {
			var callbackId = '';
		    if (callback) {
			  callbackId = cmd + '_' + generateUniqueId();
			  responseCallbacks[callbackId] = callback;
		    }
		    nativeBridge.request(cmd, args, callbackId);
		}
		
		nativeBridge.respone.connect(function (callbackId, args) {
			  var callbackFunc = responseCallbacks[callbackId];
			  if (callbackFunc) {
				callbackFunc(args);
				delete responseCallbacks[callbackId];
			  }
		});
		
		function generateUniqueId() {
			var uid = randomString(10) + "_" + (new Date()).getTime();
			 console.log(uid);
			 return uid;
		}
		
		function randomString(len) {
			len = len || 32;
			var $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
			var maxPos = $chars.length;
			var pwd = '';
			for (var i = 0; i < len; i++) {
				pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
			}
			return pwd;
		}
    }
}
